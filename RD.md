# وثيقة المتطلبات والتصميم (RD)

اسم المنتج: عُهدة
الإصدار الأساسي: 1.0.3
تاريخ الوثيقة: 2025-11-12

# 1) المقدمة
- **وصف مختصر**: عُهدة هو نظام نقطة بيع وإدارة مخزون وعملاء وصندوق بنسخة مكتبية/هاتفية، مع مزامنة سحابية اختيارية عبر Supabase. يدعم اللغة العربية افتراضياً ويقدم تجربة RTL كاملة.
- **الأهداف**:
  - إدارة المنتجات والمخزون بأنماط متعددة: وزن، قطعة، مقاسات، خلطات.
  - إدارة الفواتير والمبيعات والكاشير.
  - تتبع الدخل/المصروفات في الصندوق.
  - إدارة العملاء والديون مع سجلات الدفع والمستندات.
  - العروض الترويجية للمنتجات.
  - مزامنة جزئية مع السحابة، وتحديثات تطبيق داخلية.

# 2) النطاق
- **يشمل**: إدارة المنتجات والصور، عروض، فواتير ومبيعات، تحركات مخزون، صندوق مالي، عملاء وديون، إشعارات، نسخ احتياطي محلي، تحديثات إصدار، طباعة وتقارير أساسية.

# 2.1) الميزات
- **إدارة المنتجات متعددة الأنواع**: وزن، قطعة، مقاسات (Variants)، خلطات (Mix) مع وصف/وصفة وروابط منتجات.
- **بحث عربي محسّن**: تطبيع الحروف والتشكيل والأرقام العربية، والبحث بالباركود.
- **شبكة عرض منتجات سريعة**: تخطيط متجاوب وكاش صور محلي وتنزيل بالخلفية.
- **العروض الترويجية (Offers)**: خصم نسبي/ثابت ضمن نافذة زمنية مع تتبع الكمية المتاحة.
- **الكاشير والفواتير**: إنشاء/تعديل/أرشفة فواتير، عناصر مفصّلة، عملة مخصّصة بمعدل صرف محفوظ.
- **تحركات المخزون**: تسجيل البيع والإرجاع وربط التحركات بالفواتير/المشتريات.
- **دفتر الصندوق**: دخل/سحب/شراء/بيع مع تتبع التعديلات والحذف الناعم والقيم السابقة.
- **العملاء والديون**: إدارة العملاء، فهرسة حسب الهاتف، ديون ومدفوعات ومستندات مرتبطة.
- **الإشعارات**: تنبيهات محلية مثل انخفاض المخزون، وشارة عدد غير المقروء.
- **المزامنة والتحديثات**: مزامنة عند الاتصال، تقرير أول تشغيل، فحص تحديثات التطبيق وروابط تنزيل.
- **التوطين والواجهة**: RTL كامل، خط Cairo، Material 3، دعم عربي/إنجليزي.

# 3) الجمهور المستهدف
- أصحاب المتاجر الصغيرة والمتوسطة التي تحتاج إلى نظام بيع وإدارة مخزون محلي مع خيار مزامنة سحابي.

# 4) بيئة التشغيل
- منصات Flutter 

# 5) التبعيات الرئيسية (pubspec.yaml)
- واجهة: flutter, flutter_localizations, cupertino_icons
- شبكة/سحابة: http, supabase_flutter
- تخزين محلي: shared_preferences, path_provider, path, sqlite3_flutter_libs
- قاعدة بيانات: sqflite_common_ffi
- وسائط/ماسح: file_picker, mobile_scanner, image, zxing2, qr_flutter
- رسوم وملفات: fl_chart, pdf, printing, archive, share_plus
- حالة/إدارة: flutter_bloc, bloc, uuid, device_info_plus, font_awesome_flutter, local_hero
- أصول: assets/images/، خطوط Cairo كاملة.

# 6) معمارية النظام
- **طبقات**:
  - واجهات (pages/*): شاشات التطبيق الرئيسية والملاحية.
  - نماذج (models/*): كائنات المجال الأساسية: المنتج، الفاتورة، العميل، الدين...
  - مستودعات (repositories/*): منطق نطاق ووساطة بين الخدمات/DB والواجهات.
  - خدمات (services/*): قاعدة البيانات المحلية، المزامنة، الاتصال، التخزين الآمن، الاستعلامات، الكاش، الطباعة، التحديثات.
  - إدارة حالة: BLoC لوحدات المزامنة (bloc/*).
- **الملاحة**: واجهة جذر RootShell مع BottomNavigation (الرئيسية، الصندوق، العملاء، المخزون، الكاشير) وقائمة جانبية لعناصر إضافية (الفواتير، الديون، الإعدادات).
- **التوطين**: locale افتراضياً ar، يدعم ar/en.

# 6.1) نظام الألوان (الثيم)
- **Primary**: ‎#2D5B8A‎ (أزرق عميق هادئ) — اللون الأساسي للأزرار والعناصر البارزة.
- **Secondary**: ‎#27A5A3‎ (تركوازي) — لون مساعد وإبرازات ثانوية.
- **Surface**: ‎#F6F8FB‎ — خلفية بطاقات وشريط التطبيق AppBar.
- **Background**: ‎#EFF3F8‎ — خلفية الشاشات العامة.
- **Success**: ‎#2DBE7E‎ — دلالة النجاح/الاتصال.
- **Warning**: ‎#F3A536‎ — دلالة التحذير.
- **Error**: ‎#DA4F49‎ — دلالة الأخطاء.
- **تفاصيل الاستخدام**:
  - AppBar: خلفية Surface ونص/أيقونات Primary.
  - BottomNavigation: عنصر محدد Primary وغير المحدد أسود شفاف.
  - ElevatedButton: خلفية Primary ونص أبيض وزوايا دائرية.
  - SnackBar: خلفية Primary ونص أبيض.
  - أيقونة حالة الاتصال في الرئيسية: Success/Warning/Error حسب الحالة.
  - useMaterial3: مُفعّل. الخط العام Cairo. RTL افتراضياً.

# 7) نموذج البيانات (SQLite)
- نسخة مخطط DB: 33. موقع الملف: getApplicationSupportDirectory()/uhdav2.db. تفعيل WAL والسلوكيات: synchronous=NORMAL, busy_timeout=15000.
- **الجداول الأساسية**:
  - products: النوع (sizes|weight|piece|mix)، الاسم، qr، الأسعار، الكميات، صور رئيسية/وصف/وصفة/نص الخلطة، بصمات التزامن.
  - product_variants: مقاسات وسعر/كمية لكل مقاس.
  - product_images: عناوين URL ومسارات محلية وصورة رئيسية.
  - purchases, purchase_items: المشتريات، عناصرها، الكميات المتبقية FIFO.
  - invoices, invoice_items: الفواتير وعناصرها مع snapshot الاسم، عملة الفاتورة وسعر الصرف.
  - stock_movements: تحركات المخزون (بيع/إرجاع) مرتبطة بفاتورة/شراء.
  - cash_ledger: دفتر الصندوق (دخل | سحب | شراء | بيع) مع قيم سابقة للحذف/التعديل، soft delete.
  - customers: العملاء مع remote_id/dirty ومؤشرات بحث.
  - offers: العروض بخصم نسبي/ثابت، فترة سريان، حالة.
  - notifications: إشعارات محلية (مثل انخفاض المخزون).
  - debts, debt_payments, debt_documents: الديون، المدفوعات المرتبطة، والمستندات.
  - product_mix_links: ربط منتجات الخلطات بمنتجات مكونة.
  - store_info: معلومات المتجر والإعدادات العامة (اسم، هاتف، عنوان، شعار، مفاتيح Supabase، أسعار العملات JSON، مسار النسخ الاحتياطي).
- **فهارس**: عديدة لتحسين البحث (مثال: idx_customers_phone, idx_invoices_customer, idx_offers_* ...).

# 8) الخدمات والبنية التحتية (services/*)
- **AppDatabase (db.dart)**: تهيئة/ترقية قاعدة البيانات، أقفال متسلسلة لعمليات الكتابة، إعادة فتح آمن عند انشغال القاعدة، معاملات مجدولة.
- **ConnectionService**: حالة الاتصال بالسحابة (connected/disconnected/noInternet/unknown) مع ValueListenable.
- **SecureStorage**: تخزين مفاتيح حساسة مثل Supabase URL/API Key، اسم المتجر، عملة العرض، أسعار العملات.
- **SyncQueueService/SyncBloc**: جدولة مزامنة بالخلفية، تشغيل سلاسل مزامنة أولية وسحب المنتجات والصور، ومرحلية حسب الحالة.
- **FullSyncService/StorageSyncService/…**: سحب المنتجات/الصور وتعبئة الحقول محلياً وتهيئة الكاش للصور.
- **ProductsQueryService**: الاستعلامات عالية المستوى لمخططات عرض المنتجات (ProductSummary) وفلاتر البحث.
- **NotificationService**: شارة الإشعارات غير المقروءة والتنقل لصفحة الإشعارات.
- **AppInfoService**: جلب معلومات الإصدار/الأولوية/رابط التحميل من Supabase لتحديثات التطبيق. baselineVersion = 1.0.3.
- **FirstRunReportService**: إرسال تقرير تشغيل أول لسيرفر ثابت عند الاتصال.
- **ImageCacheService**: إدارة كاش الصور المحلية.

# 9) الصفحات والواجهات الرئيسية (pages/*)
- **HomePage**: شبكة المنتجات مع بحث عربي محسّن (تطبيع الحروف/التشكيل والأرقام)، فلاتر (متوفر، عرض، نوع)، تحديث سريع، معالجة عروض فعّالة، كاش صور محلي، عرض "خلطات" مع وصف/وصفة وروابط.
- **CashboxPage**: إدارة دفتر الصندوق (دخل/سحب/شراء/بيع) مع تتبع التعديلات والحذف الناعم.
- **CustomersPage/CustomerDetailsPage**: إدارة العملاء والبحث والفواتير المرتبطة.
- **InventoryPage/InventoryDetailsPage/AddProductPage/ProductPurchasesPage**: إدارة المخزون، تفاصيل المنتج، إضافة منتج، ربط بالمشتريات.
- **CashierPage/CashierEditPage/InvoicesPage/ReturnPage**: إنشاء/تعديل الفواتير، عناصر الفاتورة، الإرجاع وتحديث المخزون.
- **DealsPage**: إدارة العروض (offers) بفترة وسِعة كمية وخصم.
- **DebtsPage**: إدارة الديون والمدفوعات والمستندات.
- **SettingsPage**: إعدادات المتجر، أسعار العملات، نسخ احتياطي مسارياً.
- **NotificationsPage**: عرض الإشعارات.
- **OnboardingPage/BootstrapLoadingPage**: التهيئة الأولى: يتحقق من وجود URL وAPI Key لـ Supabase واسم المتجر لتحديد إظهار المعايرة.

# 10) التدفقات التشغيلية الأساسية
- **تشغيل التطبيق**: StartupGate يتحقق من الإعدادات المخزنة، يعرض Onboarding عند عدم توافر الاتصال/اسم المتجر. RootShell يهيئ ConnectionService, NotificationService, SyncQueueService, SyncBloc، ويطلق مزامنة أولية وسحب منتجات.
- **تحديثات التطبيق**: عند الاتصال، AppInfoService.fetch() تقارن بالـ baselineVersion. إن كان التحديث "ضروري" يظهر حوار مانع مع عدّ تنازلي وزر تيليجرام ورابط تحميل مباشر (إن توفر). يوجد زر تحديث بالقائمة الجانبية وشارة في AppBar.
- **بحث المنتجات**: تطبيع نص عربي متقدّم، بحث بالاسم/الباركود، فلاتر النوع/التوفر/العروض، تحميل كسول شبكي، وكاش صور بالخلفية.
- **الفواتير**: إنشاء/تعديل مع عناصر، تسعير بالعملة المختارة ومعدل صرف محفوظ محلياً، يسجل تحركات المخزون.
- **العروض**: انتقاء العرض النشط ضمن نافذة الوقت مع تحقق من الكمية. يبرز انتهاء العرض عند نفاد الكمية أو انتهاء الوقت.
- **الصندوق**: قيود دفترية مع حالات تعديل/حذف ناعم وتتبع القيم السابقة.
- **الديون**: إنشاء، دفع جزئي/كلي، مستندات مرتبطة، تواريخ استحقاق وفهرسة للفرز.

# 11) المزامنة والاتصال
- **Supabase**: يستخدم supabase_flutter للمزامنة والاستعلامات الخاصة بالتحديثات. مفاتيح الاتصال محفوظة في التخزين الآمن وإعدادات المتجر.
- **العمل دون اتصال**: قاعدة بيانات محلية كاملة. يتم جدولة المزامنة عند الاتصال وإعادة المحاولة تلقائياً. الاستعلامات والواجهات تعمل محلياً.

# 12) الأمان والخصوصية
- **تخزين المفاتيح**: URL وAPI Key لـ Supabase وبيانات المتجر تحفظ في SecureStorage. ملاحظة: يوجد مفتاح Supabase anon مضمّن في AppInfoService لاستخدام جدول app_info. يجب ضبط سياسات الوصول في Supabase لتقييد المخاطر.
- **النسخ الاحتياطي**: يدعم حفظ مسار نسخ في store_info.backup_path واستبدال قاعدة البيانات عبر AppDatabase.closeAndReplace().

# 13) الأداء والموثوقية
- **SQLite**: تفعيل WAL وbusy_timeout. تسلسل عمليات الكتابة بقفل غير متزامن لتخفيف قفل القاعدة. إعادة فتح آمن عند انشغال القاعدة.
- **واجهات**: استخدام AnimatedSwitcher/AnimatedSize/GridView adaptive. تقليل إعادة التحميل عبر debounce. كاش صور محلي لتخفيف الشبكة.

# 14) القيود المعروفة
- لا يوجد تعدد مستخدمين/أدوار داخلية حالياً.
- لا توجد مصادقة مستخدم على مستوى التطبيق (يعتمد على إعداد مخزن محلي ومفاتيح السحابة).
- بعض الخدمات تعتمد على الاتصال بـ Supabase مع سياسات RLS يجب ضبطها خارج التطبيق.

# 15) خارطة طريق مقترحة
- تقارير مالية ومخزون متقدمة ورسوم بيانية مخصصة.
- تحسين تجربة الطباعة والتقارير PDF (فواتير مخصصة وشعارات).
- تحسين إدارة الصور (ضغط، قص، رفع/تنزيل متوازي، حذف من التخزين).
- مراقبة تغيير أسعار العملات وتحديث تلقائي.

# 16) التعليمات التشغيلية للمطورين
- **الإعداد**: Flutter 3.9+، Dart SDK متوافق (sdk: ^3.9.2). تثبيت تبعيات pub.
- **تشغيل التطوير**: flutter run حسب المنصة. لسطح المكتب تستخدم sqflite_common_ffi تلقائياً.
- **الأصول**: ضع الصور في assets/images/، الخطوط Cairo معرفة مسبقاً.
- **الطباعة**: الحِزم pdf/printing مستخدمة لعرض/طباعة الوثائق.

# 17) الاختبارات
- test/* يحتوي اختبارات أولية. يوصى بإضافة اختبارات تكامل للعمليات الحرجة: إنشاء فاتورة -> تحركات المخزون -> قيود الصندوق -> التزامن.

# 18) إدارة الإصدار والتحديث
- baselineVersion = 1.0.3. يتم جلب معلومات التحديث من جدول app_info في Supabase بواسطة AppInfoService (id ثابت للتطبيق). مستويات الأولوية: عادي | متوسط | ضروري.

# 19) المكونات الرسومية الرئيسية
- RootShell: AppBar ببادج الإشعارات ونقطة حالة الاتصال. Drawer بعناصر تنقل وزر تحديث. BottomNavigation بخمس علامات تبويب.
- HomePage: شريط أدوات مع "العروض" و"تحديث" و"إظهار/إخفاء البحث". شبكة بطاقات منتجات مع صور/سلايدر/شارة عرض/وحدات قياس.

# 20) المصطلحات
- الكاشير: واجهة نقاط البيع للفواتير.
- الخلطات (mix): منتج مركب مع وصف وطريقة تحضير وروابط منتجات.
- دفتر الصندوق (cash_ledger): سجل الإيرادات والمصروفات.

# 21) اعتبارات أمنية إضافية
- يجب عدم تضمين مفاتيح حساسة في مستودع عام. إن لزم استخدام anon key للمعلومات العامة فقط (app_info) مع سياسات RLS صارمة. يفضل تحميل الإعدادات من التخزين الآمن/متغيرات بيئة عند البناء.

# 22) ملاحق
- بنية المجلدات المختصرة:
  - lib/pages: شاشات.
  - lib/services: خدمات اتصال/DB/مزامنة/كاش.
  - lib/repositories: منطق نطاق.
  - lib/models: كائنات المجال.
  - lib/bloc: كتل مزامنة.
  - assets: صور وخطوط.

— انتهى —
